name: CI - Build and Test

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  release:
    types: [ created ]

jobs:
  check-syntax:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Check Lua syntax
      run: |
        sudo apt-get update
        sudo apt-get install -y lua5.1
        
        echo "Checking Lua files..."
        find . -name "*.lua" -type f | while read file; do
          echo "Checking $file"
          luac -p "$file" || exit 1
        done
        
        echo "All Lua files are syntactically correct"
    
    - name: Check shell scripts
      run: |
        echo "Checking shell scripts..."
        find . -name "*.sh" -type f | while read file; do
          echo "Checking $file"
          shellcheck "$file" || exit 1
        done
        
        echo "All shell scripts are valid"
  
  test-install:
    runs-on: ubuntu-latest
    needs: check-syntax
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Test install script
      run: |
        echo "Testing install script..."
        
        # Создаем тестовую структуру
        mkdir -p /tmp/test-openwrt/usr/lib/lua/luci
        mkdir -p /tmp/test-openwrt/etc/config
        mkdir -p /tmp/test-openwrt/etc/init.d
        mkdir -p /tmp/test-openwrt/usr/sbin
        
        # Мокаем uci команду
        echo '#!/bin/sh
        echo "uci mock: $@"' > /tmp/test-openwrt/usr/bin/uci
        chmod +x /tmp/test-openwrt/usr/bin/uci
        
        # Добавляем в PATH
        export PATH="/tmp/test-openwrt/usr/bin:$PATH"
        
        # Тестируем install.sh
        chmod +x install.sh
        ./install.sh --help || true
        
        echo "Install script test completed"
  
  package:
    runs-on: ubuntu-latest
    needs: [check-syntax, test-install]
    if: github.event_name == 'release'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Create package directory
      run: |
        mkdir -p package/control
        
        # Создаем control файл для opkg
        cat > package/control/control << EOF
        Package: luci-app-byedpi-advanced
        Version: 1.0.0-$(date +%Y%m%d)
        Depends: luci, byedpi, curl, bash
        Architecture: all
        Maintainer: maximonchik78
        Section: luci
        Priority: optional
        Description: LuCI interface for ByeDPI with auto-detection
          Advanced web interface for ByeDPI with automatic
          DPI bypass detection and configuration.
        EOF
    
    - name: Create IPK package
      run: |
        cd package
        
        # Создаем структуру пакета
        mkdir -p data
        
        # Копируем файлы
        cp -r ../files/* data/
        cp -r ../luasrc data/usr/lib/lua/luci/
        
        # Создаем список файлов
        find data -type f | sed 's|^data/||' > control/files
        
        # Создаем архив
        tar -czf data.tar.gz -C data .
        tar -czf control.tar.gz -C control .
        
        echo "2.0" > debian-binary
        
        # Создаем IPK
        ar r luci-app-byedpi-advanced.ipk debian-binary control.tar.gz data.tar.gz
        
        # Копируем в корень
        cp luci-app-byedpi-advanced.ipk ../
        
        ls -la *.ipk
    
    - name: Upload release artifacts
      uses: softprops/action-gh-release@v1
      if: startsWith(github.ref, 'refs/tags/')
      with:
        files: |
          luci-app-byedpi-advanced.ipk
          install.sh
          uninstall.sh
        draft: false
        prerelease: false
