name: CI - Build and Test

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  release:
    types: [ created ]

jobs:
  check-syntax:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Check Lua syntax
      run: |
        sudo apt-get update
        sudo apt-get install -y lua5.1
        
        echo "Checking Lua files..."
        find . -name "*.lua" -type f | while read file; do
          echo "Checking $file"
          luac -p "$file" || exit 1
        done
        
        echo "All Lua files are syntactically correct"
    
    - name: Check shell scripts
      run: |
        echo "Checking shell scripts..."
        find . -name "*.sh" -type f | while read file; do
          echo "Checking $file"
          shellcheck "$file" || exit 1
        done
        
        echo "All shell scripts are valid"
  
    - name: Test install script
      run: |
        echo "Testing install script syntax and basic structure..."
        
        # 1. Проверяем синтаксис скрипта — это главное
        echo "1. Checking script syntax..."
        bash -n install.sh && echo "✓ install.sh syntax is valid"
        
        # 2. Проверяем наличие критических функций в скрипте
        echo "2. Checking for required functions..."
        for func in check_root check_dependencies create_dirs; do
            if grep -q "^$func()" install.sh; then
                echo "✓ Function '$func' found"
            else
                echo "⚠ Warning: Function '$func' not found"
            fi
        done
        
        # 3. Проверяем структуру файлов, которые будут копироваться
        echo "3. Verifying source file structure..."
        [ -f "files/etc/init.d/byedpi" ] && echo "✓ Init script exists" || echo "✗ Missing init script"
        [ -f "files/etc/config/byedpi" ] && echo "✓ Config file exists" || echo "✗ Missing config file"
        [ -f "luasrc/controller/byedpi.lua" ] && echo "✓ LuCI controller exists" || echo "✗ Missing LuCI controller"
        
        echo "Install script test completed (CI-safe mode)."
        echo "Note: Full functionality requires a real OpenWrt system with 'uci' command."
  
  package:
    runs-on: ubuntu-latest
    needs: [check-syntax, test-install]
    if: github.event_name == 'push' || github.event_name == 'release'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y tar gzip ar
    
    - name: Create IPK package structure
      run: |
        echo "Creating IPK package structure..."
        
        # Создаем структуру пакета
        mkdir -p ipk_build/data
        mkdir -p ipk_build/control
        
        # 1. Копируем все файлы из files/ в data/
        if [ -d "files" ]; then
            echo "Copying files from 'files/' directory..."
            cp -r files/* ipk_build/data/
        fi
        
        # 2. Копируем luasrc в правильное место
        echo "Copying LuCI files..."
        mkdir -p ipk_build/data/usr/lib/lua/luci
        if [ -d "luasrc" ]; then
            cp -r luasrc/* ipk_build/data/usr/lib/lua/luci/
        fi
        
        # 3. Создаем control файл
        echo "Creating control file..."
        cat > ipk_build/control/control << EOF
Package: luci-app-byedpi-advanced
Version: 2.0.0-$(date +%Y%m%d)
Depends: luci, byedpi, curl, bash
Architecture: all
Maintainer: maximonchik78
Section: luci
Priority: optional
Description: LuCI interface for ByeDPI with auto-detection
 Advanced web interface for ByeDPI with automatic
 DPI bypass detection and configuration.
EOF
        
        # 4. Создаем postinst скрипт для установки
        echo "Creating postinst script..."
        cat > ipk_build/control/postinst << 'EOF'
#!/bin/sh
# Post-installation script
echo "luci-app-byedpi-advanced installed successfully!"
echo "Please configure via LuCI web interface: Services -> ByeDPI"
exit 0
EOF
        chmod +x ipk_build/control/postinst
        
        # 5. Создаем prerm скрипт для удаления
        cat > ipk_build/control/prerm << 'EOF'
#!/bin/sh
# Pre-removal script
/etc/init.d/byedpi stop 2>/dev/null || true
/etc/init.d/byedpi disable 2>/dev/null || true
exit 0
EOF
        chmod +x ipk_build/control/prerm
    
    - name: Build IPK package
      run: |
        echo "Building IPK package..."
        cd ipk_build
        
        # Создаем список файлов для control/files
        find data -type f | sed 's|^data/||' > control/files
        
        # Создаем архивы
        echo "Creating data.tar.gz..."
        tar -czf data.tar.gz -C data .
        
        echo "Creating control.tar.gz..."
        tar -czf control.tar.gz -C control .
        
        echo "2.0" > debian-binary
        
        # Создаем IPK пакет
        echo "Creating IPK package..."
        ar r luci-app-byedpi-advanced.ipk debian-binary control.tar.gz data.tar.gz
        
        # Проверяем созданный пакет
        echo "Package created:"
        ls -la luci-app-byedpi-advanced.ipk
        echo ""
        echo "Package contents:"
        ar t luci-app-byedpi-advanced.ipk
        
        # Копируем в корень репозитория
        cp luci-app-byedpi-advanced.ipk ../
    
    - name: Upload release artifacts
      uses: softprops/action-gh-release@v1
      if: startsWith(github.ref, 'refs/tags/')
      with:
        files: |
          luci-app-byedpi-advanced.ipk
        draft: false
        prerelease: false
