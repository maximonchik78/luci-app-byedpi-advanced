<%+header%>

<div class="cbi-map">
    <h2><%:ByeDPI Auto-detection%></h2>
    <div class="cbi-map-descr">
        <%:Automatically detect DPI blocking methods and configure optimal bypass parameters.%>
    </div>
    
    <fieldset class="cbi-section">
        <legend><%:Auto-detection Status%></legend>
        
        <div class="cbi-value">
            <label class="cbi-value-title"><%:Status%></label>
            <div class="cbi-value-field">
                <span id="status" class="label"><%:Checking...%></span>
            </div>
        </div>
        
        <div class="cbi-value">
            <label class="cbi-value-title"><%:Current Configuration%></label>
            <div class="cbi-value-field">
                <span id="current-config">-</span>
            </div>
        </div>
        
        <div class="cbi-value">
            <label class="cbi-value-title"><%:Detection Log%></label>
            <div class="cbi-value-field">
                <pre id="log" style="height: 300px; overflow: auto; background: #f5f5f5; padding: 10px;"></pre>
            </div>
        </div>
    </fieldset>
    
    <div class="cbi-page-actions">
        <button class="cbi-button cbi-button-apply" id="btn-start">
            <i class="icon icon-play"></i> <%:Start Auto-detection%>
        </button>
        <button class="cbi-button cbi-button-reset" id="btn-stop" style="display: none;">
            <i class="icon icon-stop"></i> <%:Stop%>
        </button>
        <button class="cbi-button cbi-button-refresh" id="btn-refresh">
            <i class="icon icon-refresh"></i> <%:Refresh%>
        </button>
    </div>
</div>

<script>
var checkInterval;

function updateStatus() {
    XHR.get('<%=luci.dispatcher.build_url("admin/services/byedpi/autodetect_status")%>', null,
        function(xhr, status) {
            if (status === 200) {
                var data = JSON.parse(xhr.responseText);
                
                // Обновляем статус
                var statusEl = document.getElementById('status');
                if (data.running) {
                    statusEl.textContent = 'Running (PID: ' + data.pid + ')';
                    statusEl.className = 'label label-success';
                    document.getElementById('btn-start').style.display = 'none';
                    document.getElementById('btn-stop').style.display = '';
                } else {
                    statusEl.textContent = 'Stopped';
                    statusEl.className = 'label label-warning';
                    document.getElementById('btn-start').style.display = '';
                    document.getElementById('btn-stop').style.display = 'none';
                }
                
                // Обновляем конфигурацию
                document.getElementById('current-config').textContent = 
                    'Mode: ' + data.config_mode + ', Port: ' + data.config_port;
                
                // Обновляем лог
                updateLog();
            }
        }
    );
}

function updateLog() {
    XHR.get('<%=luci.dispatcher.build_url("admin/services/byedpi/autodetect_log")%>', null,
        function(xhr, status) {
            if (status === 200) {
                document.getElementById('log').textContent = xhr.responseText;
                // Автопрокрутка вниз
                var logEl = document.getElementById('log');
                logEl.scrollTop = logEl.scrollHeight;
            }
        }
    );
}

function startDetection() {
    if (confirm('<%:Start auto-detection? This may take 2-3 minutes.%>')) {
        XHR.post('<%=luci.dispatcher.build_url("admin/services/byedpi/autodetect")%>', 
            { action: 'start' },
            function(xhr, status) {
                if (status === 200) {
                    alert('<%:Auto-detection started. Please wait...%>');
                    updateStatus();
                }
            }
        );
    }
}

function stopDetection() {
    if (confirm('<%:Stop auto-detection?%>')) {
        XHR.get('<%=luci.dispatcher.build_url("admin/services/byedpi/autodetect_stop")%>', null,
            function(xhr, status) {
                if (status === 200) {
                    alert('<%:Auto-detection stopped.%>');
                    updateStatus();
                }
            }
        );
    }
}

// Инициализация
document.getElementById('btn-start').onclick = startDetection;
document.getElementById('btn-stop').onclick = stopDetection;
document.getElementById('btn-refresh').onclick = updateStatus;

// Автообновление каждые 3 секунды
checkInterval = setInterval(updateStatus, 3000);
window.onload = updateStatus;

// Очистка при закрытии
window.onbeforeunload = function() {
    if (checkInterval) {
        clearInterval(checkInterval);
    }
};
</script>

<style>
.label {
    display: inline-block;
    padding: 4px 8px;
    border-radius: 3px;
    font-weight: bold;
}
.label-success {
    background-color: #dff0d8;
    color: #3c763d;
}
.label-warning {
    background-color: #fcf8e3;
    color: #8a6d3b;
}
</style>

<%+footer%>
