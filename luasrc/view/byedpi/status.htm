<!-- luasrc/view/byedpi/status.htm -->
<%+header%>

<div class="cbi-map">
    <h2><%:ByeDPI Status%></h2>
    <div class="cbi-map-descr"><%:Current DPI bypass status and auto-detection results%></div>
    
    <div class="cbi-section">
        <div class="cbi-value">
            <label class="cbi-value-title"><%:Service Status%></label>
            <div class="cbi-value-field">
                <span id="service-status" class="status-label">Checking...</span>
            </div>
        </div>
        
        <div class="cbi-value">
            <label class="cbi-value-title"><%:Current Mode%></label>
            <div class="cbi-value-field">
                <span id="current-mode">-</span>
            </div>
        </div>
        
        <div class="cbi-value">
            <label class="cbi-value-title"><%:Current Port%></label>
            <div class="cbi-value-field">
                <span id="current-port">-</span>
            </div>
        </div>
        
        <div class="cbi-value">
            <label class="cbi-value-title"><%:Auto-detection Log%></label>
            <div class="cbi-value-field">
                <pre id="detection-log" style="background:#f5f5f5;padding:10px;max-height:200px;overflow:auto;"></pre>
            </div>
        </div>
    </div>
    
    <div class="cbi-page-actions">
        <button class="cbi-button cbi-button-apply" onclick="runAutoDetect()">
            <%:Run Auto-detection Now%>
        </button>
        <button class="cbi-button cbi-button-refresh" onclick="refreshStatus()">
            <%:Refresh Status%>
        </button>
    </div>
</div>

<script>
function refreshStatus() {
    XHR.get('<%=luci.dispatcher.build_url("admin/services/byedpi/status")%>', {
        timeout: 30000
    }).then(function(res) {
        var data = JSON.parse(res.responseText);
        
        // Обновляем статус
        var statusEl = document.getElementById('service-status');
        statusEl.textContent = data.running ? 'Running' : 'Stopped';
        statusEl.className = 'status-label ' + (data.running ? 'running' : 'stopped');
        
        // Обновляем параметры
        document.getElementById('current-mode').textContent = data.mode;
        document.getElementById('current-port').textContent = data.port;
        
        // Обновляем лог
        if (data.log) {
            document.getElementById('detection-log').textContent = data.log;
        }
    });
}

function runAutoDetect() {
    if (confirm('<%:Run auto-detection? This may take a few minutes.%>')) {
        XHR.get('<%=luci.dispatcher.build_url("admin/services/byedpi/autodetect")%>', {
            timeout: 30000
        }).then(function() {
            alert('<%:Auto-detection started. Check logs in a few minutes.%>');
            setTimeout(refreshStatus, 5000);
        });
    }
}

// Автообновление каждые 10 секунд
setInterval(refreshStatus, 10000);
window.onload = refreshStatus;
</script>

<style>
.status-label {
    padding: 3px 8px;
    border-radius: 3px;
    font-weight: bold;
}
.status-label.running {
    background: #d4edda;
    color: #155724;
}
.status-label.stopped {
    background: #f8d7da;
    color: #721c24;
}
</style>

<%+footer%>
