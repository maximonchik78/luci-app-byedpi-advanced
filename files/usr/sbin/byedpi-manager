#!/bin/sh

# Менеджер ByeDPI для управления сервисом

VERSION="2.0.0"
CONFIG="/etc/config/byedpi"

show_help() {
    echo "ByeDPI Manager v$VERSION"
    echo ""
    echo "Usage: $0 [command]"
    echo ""
    echo "Commands:"
    echo "  start        Start ByeDPI service"
    echo "  stop         Stop ByeDPI service"
    echo "  restart      Restart ByeDPI service"
    echo "  status       Show service status"
    echo "  config       Show current configuration"
    echo "  autodetect   Run auto-detection"
    echo "  test         Test current setup"
    echo "  log          Show recent logs"
    echo "  version      Show version information"
    echo "  help         Show this help"
    echo ""
}

show_status() {
    if pgrep -f "/usr/sbin/byedpi" >/dev/null 2>&1; then
        echo "Service status: RUNNING"
    else
        echo "Service status: STOPPED"
    fi
    
    if [ -f "$CONFIG" ]; then
        echo "Configuration: PRESENT"
    else
        echo "Configuration: MISSING"
    fi
}

show_config() {
    if [ -f "$CONFIG" ]; then
        echo "Current configuration:"
        cat "$CONFIG"
    else
        echo "Configuration file not found: $CONFIG"
    fi
}

show_log() {
    if [ -f "/tmp/byedpi-autodetect.log" ]; then
        echo "=== Auto-detection Log ==="
        tail -20 "/tmp/byedpi-autodetect.log"
    fi
    
    if [ -f "/var/log/byedpi.log" ]; then
        echo "=== Service Log ==="
        tail -20 "/var/log/byedpi.log"
    fi
}

case "$1" in
    start)
        echo "Starting ByeDPI service..."
        /etc/init.d/byedpi start
        ;;
    stop)
        echo "Stopping ByeDPI service..."
        /etc/init.d/byedpi stop
        ;;
    restart)
        echo "Restarting ByeDPI service..."
        /etc/init.d/byedpi restart
        ;;
    status)
        show_status
        ;;
    config)
        show_config
        ;;
    autodetect)
        echo "Running auto-detection..."
        /usr/sbin/byedpi-autodetect
        ;;
    test)
        echo "Testing current setup..."
        /etc/init.d/byedpi test
        ;;
    log)
        show_log
        ;;
    version)
        echo "ByeDPI Manager v$VERSION"
        ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo "Unknown command: $1"
        echo "Use '$0 help' for usage information"
        exit 1
        ;;
esac
