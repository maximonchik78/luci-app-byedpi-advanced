#!/bin/sh /etc/rc.common

START=99
STOP=10
USE_PROCD=1
NAME=byedpi

EXTRA_COMMANDS="autodetect test"
EXTRA_HELP="    autodetect  Auto-detect DPI and configure
    test       Test current configuration"

start_service() {
    local config_file="/etc/config/byedpi"
    local enabled mode port ipv6 autodetect
    
    [ -f "$config_file" ] || return 1
    
    config_load byedpi
    config_get_bool enabled settings enabled 0
    config_get mode settings mode "0"
    config_get port settings port "443"
    config_get_bool ipv6 settings ipv6 0
    config_get_bool autodetect settings autodetect 0
    
    # Если включен автоподбор, запускаем его
    if [ "$autodetect" = "1" ] && [ "$enabled" = "1" ]; then
        log "Running auto-detection..."
        /usr/sbin/byedpi-autodetect
        # Перезагружаем конфиг после автоподбора
        config_load byedpi
        config_get mode settings mode "0"
        config_get port settings port "443"
    fi
    
    if [ "$enabled" = "0" ]; then
        return 0
    fi
    
    # Формируем команду
    local cmd="/usr/sbin/byedpi"
    
    case "$mode" in
        1) cmd="$cmd --frag" ;;
        2) cmd="$cmd --wrong-chksum" ;;
        3) cmd="$cmd --wrong-seq" ;;
        4) cmd="$cmd --tamper-tcpack" ;;
        5) cmd="$cmd --tamper-tcpchksum" ;;
        0|*) cmd="$cmd --auto" ;;
    esac
    
    cmd="$cmd -p $port"
    
    [ "$ipv6" = "1" ] && cmd="$cmd --ipv6"
    
    procd_open_instance
    procd_set_param command $cmd
    procd_set_param respawn
    procd_set_param stdout 1
    procd_set_param stderr 1
    procd_close_instance
}

autodetect() {
    echo "Starting DPI auto-detection..."
    /usr/sbin/byedpi-autodetect
}

test() {
    echo "Testing current configuration..."
    
    config_load byedpi
    config_get enabled settings enabled 0
    config_get mode settings mode
    config_get port settings port
    
    if [ "$enabled" = "0" ]; then
        echo "Service is disabled"
        return 1
    fi
    
    echo "Mode: $mode"
    echo "Port: $port"
    
    # Тестируем на стандартных сайтах
    TEST_SITES="https://google.com https://youtube.com"
    
    for site in $TEST_SITES; do
        echo -n "Testing $site... "
        if curl -s -I --connect-timeout 5 "$site" >/dev/null 2>&1; then
            echo "OK"
        else
            echo "FAILED"
        fi
    done
}

service_triggers() {
    procd_add_reload_trigger "byedpi"
}
