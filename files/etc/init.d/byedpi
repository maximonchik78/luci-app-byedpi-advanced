#!/bin/sh /etc/rc.common

START=99
STOP=10
USE_PROCD=1
NAME=byedpi

EXTRA_COMMANDS="autodetect test"
EXTRA_HELP="    autodetect  Auto-detect DPI and configure
    test       Test current configuration"

start_service() {
    procd_open_instance "$NAME"
    procd_set_param command /usr/sbin/byedpi --auto -p "$(uci get byedpi.@settings[0].port 2>/dev/null || echo 443)"
    procd_set_param respawn
    procd_set_param stdout 1
    projd_set_param stderr 1
    procd_close_instance
}

stop_service() {
    killall byedpi 2>/dev/null
}

autodetect() {
    echo "Starting DPI auto-detection..."
    /usr/sbin/byedpi-autodetect
}

test() {
    echo "Testing current configuration..."
    if ! command -v uci >/dev/null 2>&1; then
        echo "uci command not found"
        return 1
    fi
    
    local enabled
    enabled=$(uci get byedpi.@settings[0].enabled 2>/dev/null || echo "0")
    
    if [ "$enabled" = "0" ]; then
        echo "Service is disabled"
        return 1
    fi
    
    echo "Mode: $(uci get byedpi.@settings[0].mode 2>/dev/null || echo 0)"
    echo "Port: $(uci get byedpi.@settings[0].port 2>/dev/null || echo 443)"
    
    echo ""
    echo "Testing connectivity..."
    
    TEST_SITES="https://google.com https://youtube.com"
    
    for site in $TEST_SITES; do
        echo -n "Testing $site... "
        if curl -s -I --connect-timeout 5 "$site" >/dev/null 2>&1; then
            echo "OK"
        else
            echo "FAILED"
        fi
    done
}

service_triggers() {
    procd_add_reload_trigger "byedpi"
}
