#!/bin/sh /etc/rc.common

START=99
STOP=10
USE_PROCD=1
NAME=byedpi

EXTRA_COMMANDS="autodetect test"
EXTRA_HELP="    autodetect  Auto-detect DPI and configure
    test       Test current configuration"

start_service() {
    local config_file="/etc/config/byedpi"
    local enabled mode port ipv6 autodetect
    
    [ -f "$config_file" ] || return 1
    
    config_load byedpi
    config_get_bool enabled settings enabled 0
    config_get mode settings mode "0"
    config_get port settings port "443"
    config_get_bool ipv6 settings ipv6 0
    config_get_bool autodetect settings autodetect 0
    
    # Если включен автоподбор при старте
    if [ "$autodetect" = "1" ] && [ "$enabled" = "1" ]; then
        logger -t "byedpi" "Running auto-detection on startup..."
        /usr/sbin/byedpi-autodetect >/dev/null 2>&1 &
        # Перезагружаем конфиг
        sleep 2
        config_load byedpi
        config_get mode settings mode "0"
        config_get port settings port "443"
    fi
    
    if [ "$enabled" = "0" ]; then
        return 0
    fi
    
    # Формируем команду
    local cmd="/usr/sbin/byedpi"
    
    case "$mode" in
        1) cmd="$cmd --ttl" ;;
        2) cmd="$cmd --wrong-chksum" ;;
        3) cmd="$cmd --wrong-seq" ;;
        4) cmd="$cmd --frag" ;;
        5) cmd="$cmd --tamper-tcpack" ;;
        6) cmd="$cmd --tamper-tcpchksum" ;;
        0|*) cmd="$cmd --auto" ;;
    esac
    
    # Добавляем порты
    cmd="$cmd -p $port"
    
    # IPv6 если включено
    [ "$ipv6" = "1" ] && cmd="$cmd --ipv6"
    
    # Добавляем демонизацию
    cmd="$cmd --daemon"
    
    procd_open_instance
    procd_set_param command $cmd
    procd_set_param respawn
    procd_set_param stdout 1
    procd_set_param stderr 1
    procd_set_param pidfile "/var/run/$NAME.pid"
    procd_close_instance
}

stop_service() {
    # Убиваем процесс если он не останавливается через procd
    killall byedpi 2>/dev/null || true
    rm -f /var/run/byedpi.pid 2>/dev/null || true
}

autodetect() {
    echo "Starting DPI auto-detection..."
    /usr/sbin/byedpi-autodetect
}

test() {
    echo "Testing current configuration..."
    
    config_load byedpi
    config_get enabled settings enabled 0
    config_get mode settings mode
    config_get port settings port
    
    if [ "$enabled" = "0" ]; then
        echo "Service is disabled"
        return 1
    fi
    
    echo "Mode: $mode"
    echo "Port: $port"
    echo ""
    echo "Testing connectivity..."
    
    TEST_SITES="https://google.com https://youtube.com https://rutracker.org"
    
    for site in $TEST_SITES; do
        printf "Testing %s... " "$site"
        if curl -s -I --connect-timeout 5 "$site" >/dev/null 2>&1; then
            echo "OK"
        else
            echo "FAILED"
        fi
    done
}

service_triggers() {
    procd_add_reload_trigger "byedpi"
}
